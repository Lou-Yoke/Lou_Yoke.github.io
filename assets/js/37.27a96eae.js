(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{528:function(n,e,t){"use strict";t.r(e);var r=t(4),s=Object(r.a)({},(function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[t("h1",{attrs:{id:"python-爬虫爬取下载网易云音乐歌单的歌曲"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#python-爬虫爬取下载网易云音乐歌单的歌曲"}},[n._v("#")]),n._v(" python 爬虫爬取下载网易云音乐歌单的歌曲")]),n._v(" "),t("blockquote",[t("p",[n._v("要点："),t("br"),n._v("\n1.js加密就是麻烦，只能百度寻求帮助。涉及的加密模块binascii、Crypto、base64"),t("br"),n._v("\n2.requests.Session的用法，可以制定headers、cookies"),t("br"),n._v("\n3.可以用scrapy.selector替代beautiful搜索"),t("br"),n._v("\n4.requests可以直接json()得到json文本")])]),n._v(" "),t("p",[n._v("说干就干，先打开charles,然后进入歌单页面"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180512135407168?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)")]),n._v(" "),t("p",[n._v("这时看charles,先从code是206（歌曲mp3或者m4a的地址）开始分析，最后找到歌单"),t("br"),n._v("\nmp3文件"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180512133341273?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\n复制mp3的url,看看哪个网站出现"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180512133637424?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\n直接找到了包含歌曲url信息的网址，不过蛋疼的事这得post,再看看post参数"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180512133744618?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\ncommand+f了一下，发现完全找不到这两个参数从哪里来的，百度了一下，特么的需要解码，算了，先跳过去，先趴歌单。"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/2018051213580355?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\n看起来很简单，歌名前面就是歌曲的id，但是没有歌手和专辑图片等信息，继续折腾。"),t("br"),n._v("\n感觉id很有用，先提出来"),t("code",[n._v("song?id=64006")]),n._v("再说，进入每一首歌的页面，再汇总"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180512162305370?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\n使用selector进行选择，筛选我们需要的信息。关于selector的使用在后边文章进行分享。代码如下：")]),n._v(" "),t("p",[n._v("​")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v("import requests,os,json,re  \nfrom scrapy.selector import Selector  \n  \nclass wangyiyun():  \n    def __init__(self):  \n        self.headers = {  \n            'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36',  \n            'Referer': 'http://music.163.com/'}  \n        self.main_url='http://music.163.com/'  \n        self.session = requests.Session()  \n        self.session.headers.update(self.headers)  \n  \n    def get_songurls(self,playlist):  \n        '''进入所选歌单页面，得出歌单里每首歌各自的ID 形式就是“song?id=64006\"'''  \n        url=self.main_url+'playlist?id=%d'% playlist  \n        re= self.session.get(url)   #直接用session进入网页，懒得构造了  \n        sel=Selector(text=re.text)   #用scrapy的Selector，懒得用BS4了  \n        songurls=sel.xpath('//ul[@class=\"f-hide\"]/li/a/@href').extract()  \n        return songurls   #所有歌曲组成的list  \n  \n    def get_songinfos(self,songurls):  \n        '''根据songid进入每首歌对应的url，拿到歌手名字，url就是:\"http://music.163.com/song?id=64006\"'''  \n        for songurl in songurls:  \n            url=self.main_url+songurl  \n            re=self.session.get(url)  \n            sel=Selector(text=re.text)  \n            song_id = url.split('=')[1]  \n            song_name = sel.xpath(\"//em[@class='f-ff2']/text()\").extract_first()  \n            singer= '&'.join(sel.xpath(\"//p[@class='des s-fc4']/span/a/text()\").extract())  \n            print(song_id,song_name,singer)  \n  \n    def work(self,playlist):  \n        songurls=self.get_songurls(playlist)  \n        self.get_songinfos(songurls)  \n  \nd=wangyiyun()  \nd.work(2214059025)  \n")])])]),t("p",[n._v("结果如下：")]),n._v(" "),t("p",[n._v("​"),t("br"),n._v("\n​    64006 失恋王 陈小春"),t("br"),n._v("\n​    63969 啼笑姻缘 陈小春"),t("br"),n._v("\n​    25642714 算你狠 陈小春"),t("br"),n._v("\n​    63914 友情岁月 陈小春"),t("br"),n._v("\n​    4878122 乱世巨星 陈小春"),t("br"),n._v("\n​    63650 独家记忆 陈小春")]),n._v(" "),t("p",[n._v("好了！到了最难搞的部分，解码！！！"),t("br"),n._v("\n说实话第一次接触，真的看不明白，所以参考了很多的帖子。"),t("br"),n._v("\n刚刚得到了歌单的歌曲的ID、歌名、歌手和专辑照片等内容。"),t("br"),n._v("\n接着就是如何根据歌曲ID得到MP3的URL了，很明显，中间得经过这个网址"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180512190604544?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\n这两个参数"),t("code",[n._v("params")]),n._v("和"),t("code",[n._v("encSecKey")]),n._v("哪里来的呢，就是要解码！！"),t("br"),n._v(" "),t("img",{attrs:{src:"http://img.zhanghuanglong.com//image/2017/11/16/20171116215037975793.png",alt:""}}),t("br"),n._v("\n点击歌曲所在页面的控制台（F12）sources，可以看到有很多请求的数据，这里包含了js、css、image以及页面，基本上大的公司加密的方法都是放在一个单独的js文件中，所以我们可以一个一个展开只选择js文件，然后搜索参数"),t("code",[n._v("parame")]),n._v("或者"),t("code",[n._v("encseckey")]),n._v("其中一个即可"),t("br"),n._v(" "),t("img",{attrs:{src:"http://img.zhanghuanglong.com//image/2017/11/16/20171116224445564363.png",alt:""}}),t("br"),n._v("\n可以看到图中这个care.js含有三个encSecKey,那就应该是它了，最后再点击红色箭头所指的就可以美化代码了，不然你就只能看着一坨坨的 "),t("em",[n._v("**")]),t("br"),n._v(" "),t("img",{attrs:{src:"http://img.zhanghuanglong.com//image/2017/11/16/20171116224839400490.png",alt:""}}),t("br"),n._v("\n通过搜索就可以看到这里有我们需要的两个参数，那么接下来就只需要研究这两个参数所在的上面一部分代码即可，其他代码都无需再管。")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v('var bBj9a = window.asrsea(JSON.stringify(j3x), bwA8s(["流泪", "强"]), bwA8s(Uf9W.md), bwA8s(["爱心", "女孩", "惊恐", "大笑"]));  \ne3x.data = k3x.cC4G({  \n    params: bBj9a.encText,  \n    encSecKey: bBj9a.encSecKey  \n')])])]),t("p",[n._v("这是JS了，完全看不懂，看了大神们的解说，也是一知半解，所以，跟着大神的脚步慢慢抄"),t("br"),n._v("\n先把window.asrsea这个函数代码，command+f搜索出来，有两个，找到另一个如下：")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v('!function() {  \n    function a(a) {  \n        var d, e, b = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789", c = "";  \n        for (d = 0; a > d; d += 1)  \n            e = Math.random() * b.length,  \n            e = Math.floor(e),  \n            c += b.charAt(e);  \n        return c  \n    }  \n    function b(a, b) {  \n        var c = CryptoJS.enc.Utf8.parse(b)  \n          , d = CryptoJS.enc.Utf8.parse("0102030405060708")  \n          , e = CryptoJS.enc.Utf8.parse(a)  \n          , f = CryptoJS.AES.encrypt(e, c, {  \n            iv: d,  \n            mode: CryptoJS.mode.CBC  \n        });  \n        return f.toString()  \n    }  \n    function c(a, b, c) {  \n        var d, e;  \n        return setMaxDigits(131),  \n        d = new RSAKeyPair(b,"",c),  \n        e = encryptedString(d, a)  \n    }  \n    function d(d, e, f, g) {  \n        var h = {}  \n          , i = a(16);  \n        return h.encText = b(d, g),  \n        h.encText = b(h.encText, i),  \n        h.encSecKey = c(i, e, f),  \n        h  \n    }  \n    function e(a, b, d, e) {  \n        var f = {};  \n        return f.encText = c(a + e, b, d),  \n        f  \n    }  \n    window.asrsea = d,  \n    window.ecnonasr = e  \n}();  \n')])])]),t("p",[n._v("注意了，"),t("code",[n._v("window.asrsea = d")]),n._v("，意思就是这个window.asrsea函数就是d")]),n._v(" "),t("p",[n._v("​"),t("br"),n._v("\n​    function d(d, e, f, g) {"),t("br"),n._v("\n​            var h = {}"),t("br"),n._v("\n​              , i = a(16);"),t("br"),n._v("\n​            return h.encText = b(d, g),"),t("br"),n._v("\n​            h.encText = b(h.encText, i),"),t("br"),n._v("\n​            h.encSecKey = c(i, e, f),"),t("br"),n._v("\n​            h"),t("br"),n._v("\n​        }")]),n._v(" "),t("p",[n._v("回头看看window.asrsea，有四个参数，其实就是对应上面的d,e,f,g，把这四个参数带入后，返回的")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v("h.encText----------\x3eparams: bBj9a.encText,  \nh.encSecKey--------\x3eencSecKey: bBj9a.encSecKey  \n")])])]),t("p",[n._v("所以破解了这个d函数就能得到我们想要的2个参数了"),t("br"),n._v("\n先调用a函数得到i——–>i=a(16)"),t("br"),n._v("\n接着h.enxTect,调用两次b函数，h.nexText = b(d,g)———>h.encText=b)(h.encText,i)"),t("br"),n._v("\n最后，h.encSecKey,调用了c函数，——->h.encSecKey = c(i,e,f)")]),n._v(" "),t("p",[n._v("开始破解")]),n._v(" "),t("ol",[t("li",[t("p",[n._v("先破解i，搞懂a函数")]),n._v(" "),t("p",[n._v("function a(a) {"),t("br"),n._v('\nvar d, e, b = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789", c = "";'),t("br"),n._v("\nfor (d = 0; a > d; d += 1)"),t("br"),n._v("\ne = Math.random() * b.length,"),t("br"),n._v("\ne = Math.floor(e),"),t("br"),n._v("\nc += b.charAt(e);"),t("br"),n._v("\nreturn c"),t("br"),n._v("\n}")])])]),n._v(" "),t("p",[n._v("大佬们都说a方法是产生16位随机字符串，其实可以用固定的，不过还是用一下随机生成的吧，看着很简单"),t("code",[n._v("i=binascii.hexlify(os.urandom(16))[:16]")]),t("br"),n._v("\n分析：binascii.hexlify() 就是把字符串每一个字节的数据转换成相应的2位十六进制表示")]),n._v(" "),t("p",[n._v("​"),t("br"),n._v("\n​    os.urandom(n) 是一种随机生成n个字节字符串的方法\n​"),t("br"),n._v("\n​      特么真的其实就是随机搞个16位的字符串，而且是bytes\n​"),t("br"),n._v("\nb'40c9505f1d021439'")]),n._v(" "),t("p",[n._v("好了，后期该用固定的了。")]),n._v(" "),t("ol",[t("li",[n._v("接着，就是吧h.encText搞出来，b函数")])]),n._v(" "),t("p",[n._v("h.encText = b(d, g)———->h.encText = b(h.encText, i)")]),n._v(" "),t("p",[n._v("​"),t("br"),n._v("\n​    function b(a, b) {"),t("br"),n._v("\n​            var c = CryptoJS.enc.Utf8.parse(b)"),t("br"),n._v('\n​              , d = CryptoJS.enc.Utf8.parse("0102030405060708")'),t("br"),n._v("\n​              , e = CryptoJS.enc.Utf8.parse(a)"),t("br"),n._v("\n​              , f = CryptoJS.AES.encrypt(e, c, {"),t("br"),n._v("\n​                iv: d,"),t("br"),n._v("\n​                mode: CryptoJS.mode.CBC"),t("br"),n._v("\n​            });"),t("br"),n._v("\n​            return f.toString()"),t("br"),n._v("\n​        }")]),n._v(" "),t("p",[n._v("很明显，看不懂，继续看大佬们分析：")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v('from Crypto.Cipher import AES  \nimport base64  \n  \ndef aes_encrypt(text, key):  \n    iv = "0102030405060708"  \n    pad = 16 - len(text) % 16  \n    text = text + pad * chr(pad)  \n    encryptor = AES.new(key, AES.MODE_CBC, iv)  \n    result = encryptor.encrypt(text)  \n    result_str = base64.b64encode(result)  \n    return result_str  \n')])])]),t("p",[n._v("很明显，依旧看不懂，不过还是能看懂一部分内容的。")]),n._v(" "),t("ol",[t("li",[n._v("最后，就是把h.encSecKey搞出来，c函数")])]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v('function c(a, b, c) {  \n       var d, e;  \n       return setMaxDigits(131),  \n       d = new RSAKeyPair(b,"",c),  \n       e = encryptedString(d, a)  \n   }  \n')])])]),t("p",[n._v("大佬们的写法：")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v("def rsa_encrpt(text, pubKey, modulus):  \n    text = text[::-1]  \n    rs = pow(int(binascii.hexlify(text), 16), int(pubKey, 16), int(modulus, 16))  \n    return format(rs, 'x').zfill(256)  \n")])])]),t("p",[n._v("OK，现在把函数都搞清楚了，再回头看整个原函数：")]),n._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[n._v('var bBj9a = window.asrsea(JSON.stringify(j3x), bwA8s(["流泪", "强"]), bwA8s(Uf9W.md), bwA8s(["爱心", "女孩", "惊恐", "大笑"]));  \ne3x.data = k3x.cC4G({  \n    params: bBj9a.encText,  \n    encSecKey: bBj9a.encSecKey  \n')])])]),t("p",[n._v("输入的四个参数什么东西？"),t("br"),n._v("\n关于这个，大佬们说可以像pycharm可以设断点，就能看到这4个参数的值了，我也折腾了很久，终于搞明白了。"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180513075404406?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\n设置断电，然后按播放"),t("br"),n._v("\n![](https://img-\nblog.csdn.net/20180513075942396?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjgyNzA2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)"),t("br"),n._v("\n还得按多记下右上角的resume，再选中参数，就能看到参数的值了！！")]),n._v(" "),t("p",[n._v("第一个参数明显跟歌曲的id有关，其余3个都是常量，现在可以把这个解码给写出来了！！"),t("br"),n._v("\nok ! 成功了，最后整合一下代码，完成，收工。")])])}),[],!1,null,null,null);e.default=s.exports}}]);