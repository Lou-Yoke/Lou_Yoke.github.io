(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{519:function(e,r,t){"use strict";t.r(r);var c=t(4),a=Object(c.a)({},(function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"一个海量在线用户即时通讯系统（im）的完整设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一个海量在线用户即时通讯系统（im）的完整设计"}},[e._v("#")]),e._v(" 一个海量在线用户即时通讯系统（IM）的完整设计")]),e._v(" "),t("p",[t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SntIKrFFBpE2rSZEdiakHfG5qLd4oPGq2doz4HC374wAylDIGa6jc83dQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n改文章转载自"),t("a",{attrs:{href:"http://www.baidu.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("普通程序员"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"_1-服务器端设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-服务器端设计"}},[e._v("#")]),e._v(" 1. "),t("strong",[e._v("服务器端设计")])]),e._v(" "),t("h3",{attrs:{id:"_1-1-总架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-总架构"}},[e._v("#")]),e._v(" 1.1 总架构")]),e._v(" "),t("p",[e._v("总架构包括5个层级，具体内容如下图。"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnOPj8iaE2VwISkKY5uwSemnsbfjOyl9MNL68PmrFMG5gE892IiasCUVnw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1,%22%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%845%E4%B8%AA%E5%B1%82%E6%AC%A1%22",alt:""}})]),e._v(" "),t("p",[e._v("1.1.1 用户端"),t("br"),e._v("\n移动端重点是移动端，支持IOS/Android系统，包括IM App，嵌入消息功能的瓜子App，未来还可能接入客服系统。")]),e._v(" "),t("p",[e._v("1.1.2 用户端API"),t("br"),e._v("\n针对TCP协议，提供IOS/Android开发SDK。对于H5页面，提供WebSocket接口")]),e._v(" "),t("p",[e._v("1.1.3 接入层"),t("br"),e._v("\n接入层主要任务是保持海量用户连接（接入）、攻击防护、将海量连接整流成少量TCP连接与逻辑层通讯。")]),e._v(" "),t("p",[e._v("1.1.4 逻辑层"),t("br"),e._v("\n逻辑层负责IM系统各项功能的核心逻辑实现。包括单聊（c2c）、上报(c2s)、推送(s2c)、群聊(c2g)、离线消息、登录授权、组织机构树等等内容。")]),e._v(" "),t("p",[e._v("1.1.5 存储层"),t("br"),e._v("\n存储层负责缓存或存储IM系统相关数据，主要包括用户状态及路由（缓存），消息数据（MySQL也可采用NoSql，如MangoDB），文件数据（文件服务器）。")]),e._v(" "),t("h3",{attrs:{id:"_1-2-逻辑结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-逻辑结构"}},[e._v("#")]),e._v(" 1.2 逻辑结构")]),e._v(" "),t("p",[e._v("1.2.1 核心结构"),t("br"),e._v("\n核心结构部分描述IM系统核心组件及其关系。结构图如下。")]),e._v(" "),t("p",[t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9Sn9kRics7GNicSzYQhQd3vskJH5CgQGhARyVFvE5P1OHvXuvYC0Ip7hj3w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1,%22%E6%A0%B8%E5%BF%83%E7%BB%93%E6%9E%84%E5%9B%BE%22",alt:""}})]),e._v(" "),t("p",[e._v("客户端从Iplist服务获取接入层IP地址（也可采用域名的方式解析得到接入层IP地址），建立与接入层的连接（可能为短连接），从而实现客户端与IM服务器的数据交互；业务线服务器可以通过服务器端API建立与IM服务器的联系，向客户端推送消息；客户端上报到业务服务器的消息，IM服务器会通过mq投递给业务服务器。")]),e._v(" "),t("p",[e._v("1.2.2 tcp介入核心流程")]),e._v(" "),t("p",[e._v("1.2.2.1 登陆授权（auth）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnhvYS8Q7HDXNHNcw0I35WJjibGzTib2IY2bfoELfRjl3ZypCXiabxFnj9A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1,%22%E7%99%BB%E9%99%86%E6%8E%88%E6%9D%83%22",alt:""}})]),e._v(" "),t("p",[e._v("1、客户端通过统一登陆系统实现登陆，得到token."),t("br"),e._v("\n2、客户端用UID和token向msg-gate发起授权验证码请求"),t("br"),e._v("\n3、msg-gate同步调用msg-logic的验证接口"),t("br"),e._v("\n4、msg-logic请求sso系统验证token合法性"),t("br"),e._v("\n5、msg-gate得到登陆结果后，设置session状态，并向客户端返回授权结果。")]),e._v(" "),t("p",[e._v("1.2.2.2 登出（logout）")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnN8sWk4JpU7rxWgZe6TcjAkURgbiaHu2ze30l43HE1Xmw7mDBkVO4uhw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1&retryload=1,%22%E7%81%AF%E5%A4%84%22",alt:""}})]),e._v(" "),t("p",[e._v("1、客户端发起logout请求，msg-gate设置对应Peer为未登陆状态。"),t("br"),e._v("\n2、Msg-gate给客户端一个ack响应。"),t("br"),e._v("\n3、msg-gate通知msg-logic用户登出。")]),e._v(" "),t("p",[e._v("1.2.2.3 踢人（kickout）"),t("br"),e._v("\n用户请求授权时，可能在另一个设备（同类型设备）开着软件处于登陆状态。这种情况需要系统将那个设备踢下线。"),t("br"),e._v(" "),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9Snv8z2hglRmHYRQa5anV69SGZlWf5jtv0ChILFzVh46XoYwCGf1Kb8MQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1&retryload=1",alt:""}})]),e._v(" "),t("p",[e._v("1-5步参考auth流程。"),t("br"),e._v("\n6、logic检索redis，查看是否该用户在其他地方登陆。"),t("br"),e._v("\n7、如果在其他地方登陆，发起kickout命令。（如果没有登陆，整个流程结束）"),t("br"),e._v("\n8、Gate向用户发起kickout请求，并在短时间内（确保客户端收到kickout数据）关闭socket连接。")]),e._v(" "),t("p",[e._v("1.2.2.4 上报（c2s）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnfJ4a6sicWH9OoMJoXX12Richicnyrj4pKjH5jUMReRebjIcuORdKN6vAA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1,%22C2S%22",alt:""}})]),e._v(" "),t("p",[e._v("1、客户端向gate发送数据"),t("br"),e._v("\n2、gate回一个ack包，向客户端确认已经收到数据"),t("br"),e._v("\n3、gate将数据包传递给logic"),t("br"),e._v("\n4、logic根据数据投递目的地，选择对应的mq队列进行投递"),t("br"),e._v("\n5、业务服务器得到数据")]),e._v(" "),t("p",[e._v("1.2.2.5 推送（S2C）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnO6FfY7xlyW0ibyFOtBKcu4VdK97cp1TpB42IQPkiameTNpFv2N3ZCstw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1,%22%E6%8E%A8%E9%80%81%22",alt:""}})]),e._v(" "),t("p",[e._v("1、业务线调用push数据接口sendMsg"),t("br"),e._v("\n2、Logic向redis检索目标用户状态。如果目标用户不存在，丢弃数据（未来可根据业务场景定制化逻辑）如果用户在线，查询到用户连接的接入层gate"),t("br"),e._v("\n3、logic向用户所在的gate发送数据"),t("br"),e._v("\n4、gate向用户推送数据。（如果用户不在线，通知logic用户不在线）"),t("br"),e._v("\n5、客户端收到数据后向gate发送ack反馈"),t("br"),e._v("\n6、gate将ack信息传递给logic层，用于其他可能的逻辑处理（如日志，确认送达等）")]),e._v(" "),t("p",[e._v("1.2.2.6 单对单聊天（c2c）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnCuZaGTfMfXNW9tGFzwSziaUiay05kkdpDiarypkJDakricEL0gsicP7ChBg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}})]),e._v(" "),t("p",[e._v("1、App1向gate1发送信息（信息最终要发给App2）"),t("br"),e._v("\n2、gate1将信息投递给logic"),t("br"),e._v("\n3、logic收到信息后，将信息进行存储"),t("br"),e._v("\n4、存储成功后，logic向gate1发送ack"),t("br"),e._v("\n5、gate1将ack信息发给App1"),t("br"),e._v("\n6、logic检索redis，查找App2状态。如果App2未登陆，流程结束"),t("br"),e._v("\n7、如果App2登陆到了gate2，logic将消息发往gate2"),t("br"),e._v("\n8、gate2将消息发给App2（如果发现App2不在线，丢弃消息即可，这种概率极低，后续离线消息可保证消息不丢）"),t("br"),e._v("\n9、App2向gate2发送ack"),t("br"),e._v("\n10、Gate2将ack信息发给logic"),t("br"),e._v("\n11、再第6步和第7步之间，启动计时器（DelayedQueue或哈希环，时间如5秒），计时器时间到后，探测该条消息状态，如果消息未送达，考虑通过APNS、米推、个推进行推送")]),e._v(" "),t("p",[e._v("1.2.2.7 群聊（c2g）"),t("br"),e._v("\n采用"),t("code",[e._v("扩散写")]),e._v("（而非扩散读）的方式。"),t("br"),e._v("\n群聊是多人社交的基本诉求，一个群友在群内发了一个消息："),t("br"),e._v("\n（1）在线的群友能第一时间收到消息"),t("br"),e._v("\n（2）离线的群友能在登陆后收到消息"),t("br"),e._v("\n由于“[消息风暴扩散系数](https://www.w3cschool.cn/architectroad/architectroad-qq-status-\nconsistency.html)”的存在，群消息的复杂度要远高于单对单消息。"),t("br"),e._v("\n群基础表：用来描述一个群的基本信息")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("im_group_msgs(group_id, group_name,create_user, owner, announcement, create_time)  \n")])])]),t("p",[e._v("群成员表：用来描述一个群里有多少成员")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("im_group_users(group_id, user_id)   \n```   \n用户接收消息表：用来描述一个用户的所有收到群消息（与单对单消息表是同一个表）  \n")])])]),t("p",[e._v("im_message_recieve（msg_id,msg_from,msg_to, group_id，msg_seq, msg_content,\nsend_time, msg_type, deliverd, cmd_id）")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[e._v("用户发送消息表：用来描述一个用户发送了哪些消息  \n")])])]),t("p",[e._v("im_message_send (msg_id,msg_from,msg_to, group_id，msg_seq, msg_content,\nsend_time, msg_type, cmd_id)")]),e._v(" "),t("p",[e._v("业务场景举例："),t("br"),e._v("\n（1）一个群中有x,A,B,C,D共5个成员，成员x发了一个消息"),t("br"),e._v("\n（2）成员A与B在线，期望实时收到消息"),t("br"),e._v("\n（3）成员C与D离线，期望未来拉取到离线消息"),t("br"),e._v("\n群聊流程如下图所示"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnTLvJ4GMEAmQm9aMhB1wUqtmKmdhVGbMeofib5pFdVAjRzxRO0JhSmWA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n1、X向gate发送信息（信息最终要发给这个群，A、B在线）"),t("br"),e._v("\n2、Gate将消息发给logic"),t("br"),e._v("\n3、存储消息到im_message_send表，按照msg_from水平分库"),t("br"),e._v("\n4、回ack"),t("br"),e._v("\n5、回ack"),t("br"),e._v("\n6、Logic检索数据库（需要使用缓存），获得群成员列表"),t("br"),e._v("\n7、存储每个用户的消息数据（用户视图），按照msg_to水平分库(并发、批量写入)。"),t("br"),e._v("\n8、查询用户在线状态及位置"),t("br"),e._v("\n9、Logic向gate投递消息"),t("br"),e._v("\n10、Gate向用户投递消息"),t("br"),e._v("\n11、App返回收到消息的ack信息"),t("br"),e._v("\n12、Gate向logic传递ack信息"),t("br"),e._v("\n13、向缓存（Hash）中更新收到ack的时间。然后在通过一个定时任务，每隔一定时间，将数据更新到数据库（注意只需要写入时间段内有变化的数据）。")]),e._v(" "),t("p",[e._v("1.2.2.8 拉取离线消息")]),e._v(" "),t("p",[e._v("下图中，将gate和logic合并为im-server。拉取离线消息流程如下。"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnKwJuDkpcurf6UCZtTfO4fFmPm8GDm2AFB0czag9x79d8RhH7N298iaA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n1、\nApp端登录成功后（或业务触发拉取离线消息），向IM系统发起拉离线消息请求。传递3个主要参数，uid表明用户；msgid表明当前收到的最大消息id（如果没收到过消息，或拿不到最大消息id则msgid=0）即可；size表示每次拉取条数（这个值也可以由服务器端控制）。"),t("br"),e._v("\n2、 假设msgid==0，什么都不做。（参看第6步骤）"),t("br"),e._v("\n3、 Im-server查询用户前10条离线消息"),t("br"),e._v("\n4、 将离线消息推给用户。假设这10条离线消息最大msgid=110。"),t("br"),e._v("\n5、\nApp得到数据，判断得到的数据不为空（表明可能没有拉完离线数据，不用<10条做判断拉完条件,因为服务端需要下下次拉离线的请求来确定这次数据已送达），继续发起拉取操作。Msgid=110(取得到的离线消息中最大的msgid)。"),t("br"),e._v("\n6、 Im-server删除该用户msgid<110的离线消息（或者标记为已送达）。"),t("br"),e._v("\n7、 查询msgid>110的钱10条离线数据。"),t("br"),e._v("\n8、 返回给App"),t("br"),e._v("\n……"),t("br"),e._v("\nN-1、查询msgid>140的离线数据，0条（没有离线数据了）。"),t("br"),e._v("\nN 、将数据返回App，App判断拉取到0条数据，结束离线拉取过程。")]),e._v(" "),t("p",[e._v("1.2.3 PUSH"),t("br"),e._v("\nISO采用APNS；Android真后台保活，同时增加米推、个推。"),t("br"),e._v("\n基本思路：push提示信息，App通过拉离线获得真实消息。"),t("br"),e._v("\n另附文档说明此问题。")]),e._v(" "),t("h2",{attrs:{id:"_2-协议设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-协议设计"}},[e._v("#")]),e._v(" "),t("strong",[e._v("2. 协议设计")])]),e._v(" "),t("h3",{attrs:{id:"_2-1-tcp数据协议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-tcp数据协议"}},[e._v("#")]),e._v(" 2.1 TCP数据协议")]),e._v(" "),t("p",[e._v("TCP的数据协议如下图所示。包括header和body两部分。"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnRW6MViaZfcJuQtFwXibR28gDfavf7tjMbYoXxc7D96hASmXHhjVVxTwg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n消息头总共20个字节，具体信息如下表。"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnFUZX8Hp5x9JUMWUiaib3ibHdtibrWUGSOmSpr6VbAibtIpFK40p8V7LxKhQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}})]),e._v(" "),t("h2",{attrs:{id:"_2-2-tcp消息体设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-tcp消息体设计"}},[e._v("#")]),e._v(" 2.2 TCP消息体设计")]),e._v(" "),t("p",[e._v("消息体协议采用ProtocolBuffer（谷歌）协议，版本3.0.0，该协议在序列化效率、压缩、可扩展方面都具有优势。协议条目见附录11.1.1TCP协议命令清单。以下为主要流程涉及的协议"),t("br"),e._v("\n2.2.1 认证（auth）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnOCAo9r2Xn93N4h01lhjkvxqrytMbeibTxdYwsdic2e5zg5ib9qB88Vvpw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n2.2.2 登出（logout）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnReFtsTXMsT0969R6ZKwfsl2am01FIia94jV2wKTAgXP9zrvibILibFDqA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n2.2.3 踢人（kickout）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnDcyLQH61L1WiaLBqzX64zpf5OIOgqT4cYZk438Q0E8pEnefDKecZ7nA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n2.2.4 心跳(keepalive,noop)"),t("br"),e._v("\n心跳包消息体为空。")]),e._v(" "),t("p",[e._v("2.2.5 单对单聊天（c2c）")]),e._v(" "),t("p",[t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9Snh7SKhb5Mz6uz646aPUDVZicRxcf5Itf7rueDwEXbwmAgAMDl7xLpJBQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9Snp4q4BDcVLPMMmbuuCIibIKDCo38yTBy7sztic49xMA1QmcG9Y1EHsrxw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n2.2.6 群聊（c2g）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SncHJGTNIdO084LjXsIW3YknicrkNKC3GrfkqpV6GAEVyLCmxkic9mTiafg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SngT56P9ymS4iblhxa3icmMXpJPdyy3V2qMH6rXic8G7QxawjfjjIJh2PJA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n2.2.7 拉离线（pull）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnQoMTUsfeIZHvBMlEJyKNLQ6aVF6icIv5DtZiaj9TNvX7tKxGd7oI4Edg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n2.2.8 控制类（ctrl）"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnxkpajlGaY8joiahBYZibpBgSiarJ5vZxv3cOrZibcW87aDEl5sEJsYetrw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnH89AFEYrPxjWl9yqVOOZVICtRgSwKD7ub3ASoAsqJ3fbbCiaCO5bjzw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}})]),e._v(" "),t("h2",{attrs:{id:"_3-存储设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-存储设计"}},[e._v("#")]),e._v(" "),t("strong",[e._v("3. 存储设计")])]),e._v(" "),t("h3",{attrs:{id:"_3-1-mysql数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-mysql数据库"}},[e._v("#")]),e._v(" 3.1 MySQL数据库")]),e._v(" "),t("p",[e._v("MYSQL数据库采用utf8mb4编码格式（emoji字符问题）"),t("br"),e._v("\n3.1.1 主要表结构"),t("br"),e._v("\n3.1.1.1 发送消息表"),t("br"),e._v("\n保存某个用户发送了哪些消息，用于复现用户聊天场景（消息漫游功能需要）。"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnGsW0Xa8IEyBuIB0icPXKd9BVU8icfYKwI6zdOfuc9oApjIZvHmRZOlaw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n3.1.1.2 推送消息表"),t("br"),e._v("\n保存某个用户收到了哪些消息"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnsyQZFS8VGYUVMZEKvYLVrqLueSUaaRTKOv8Oek55vT9ZicUYL5kUXHw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n3.1.1.3 群相关表"),t("br"),e._v("\n群基本信息表"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnQ2T9qe8MUeJSuQNctXN4Lb3UOhibId2Jthu1QVQAyxHnZkpJ5SQ7icvQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}}),t("br"),e._v("\n群用户关系表"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9SnqjgFuOicicoCslxaQSoLlGhchibpQrQbTFb4V3iaP1GdyeHhicUjuh9o78Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}})]),e._v(" "),t("p",[e._v("3.1.2 水平分库"),t("br"),e._v(" "),t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/bwicjdKXbf3oMR6I7oTLv5icwpKs9LJ9Sns4CtLCJnZ7q4joJLewJPaRhpclLBZSicUZvrX9E9yew0LquUxJpsBcA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:""}})]),e._v(" "),t("h3",{attrs:{id:"_3-2-redis缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-redis缓存"}},[e._v("#")]),e._v(" 3.2 Redis缓存")]),e._v(" "),t("p",[e._v("3.2.1 用户状态几路由信息"),t("br"),e._v("\nRedis缓存以uid为key，检索channel(socketid)，last_packet_time等。"),t("br"),e._v("\nGate层，session以channel(socketed)为key，检索uid，及其他信息。"),t("br"),e._v("\n交互接口：gate->logic，通过将channel转换为uid作为key。"),t("br"),e._v("\nlogic->gate，将uid转换为channel作为key。")]),e._v(" "),t("p",[e._v("3.2.2 其他缓存信息"),t("br"),e._v("\n你觉得该存怎么存就怎么存")]),e._v(" "),t("h3",{attrs:{id:"_3-3-文件及图片存储"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-文件及图片存储"}},[e._v("#")]),e._v(" 3.3 文件及图片存储")]),e._v(" "),t("p",[e._v("采用商业云存储。")]),e._v(" "),t("h3",{attrs:{id:"_3-4-数据归档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-数据归档"}},[e._v("#")]),e._v(" 3.4 数据归档")]),e._v(" "),t("p",[e._v("可考虑采用HBase，HDFS作为数据归档，或者相关云存储服务。")]),e._v(" "),t("h2",{attrs:{id:"相关阅读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#相关阅读"}},[e._v("#")]),e._v(" "),t("strong",[e._v("相关阅读")])]),e._v(" "),t("p",[t("strong",[e._v("系统整体设计")]),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483920&idx=1&sn=eef0b3c7064e2563100d634416fe956c&chksm=ea04488fdd73c199d0f34fe5aa56d67ec554ab9ae67ba16f11bba29e12c1629501b671957b38&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("从零开始搭建瓜子IM系统"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("strong",[e._v("协议")]),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247484118&idx=1&sn=f9f3f77d25475357570bb4d0ba7c0154&chksm=ea044849dd73c15fa08915754f6e7ead6a3b19270bcbdc2a1bbd8bdf61b2bd4a316c31c8aae3&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("网络编程实战—-IM系统是怎么通讯的"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483692&idx=1&sn=586b4425d402f6d990adc36a88a25f89&chksm=ea044bb3dd73c2a5ca7100ebbd19bffaba7c72d24e2f108c4d8bb06f7b0c49805a24f07332b1&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("IM系统如何调试TCP协议"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("strong",[e._v("主要设计及问题")]),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483859&idx=1&sn=51bdc587fd4a2ab6334e2ce7b82bf3f2&chksm=ea044b4cdd73c25ac7e97542f82cc248b807df613cb2e28cf2726482428bddf9a717b89fcf7d&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("TimeLine模型下确保消息有序不丢"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483854&idx=1&sn=f87ef6cac20032e1a97076cabc36a648&chksm=ea044b51dd73c24723d13c9265dd11dd30ae143dcb44b6b8777ae125478f0b6494e9de464624&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("基于TimeLine模型的消息同步机制"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483714&idx=1&sn=8f12924038a8d7857c3c9a4fbff8bbac&chksm=ea044bdddd73c2cb16c500fc9077074435216330e8b9b41daaf19c18261249fef1280c9f0566&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("IM系统的SESSION结构"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483932&idx=1&sn=f83bb39f128128cf4265b1ca13e91354&chksm=ea044883dd73c19571038f0dae5e1e22fbb819b0c2fe9187856fb76ba9c8dd6d1fdd8efe055f&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("上线过程踩到的反序列化的坑"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483867&idx=1&sn=512d02658d34f3288a986d37637bfbad&chksm=ea044b44dd73c2522dde2196090d218610b61717204ce963caedcbcd7e9ae4813f73756bdc70&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis\nSortedSet结构score字段丢失精度问题解决办法"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483847&idx=1&sn=b4bbf9e0250a677d998a919cbca6a3c5&chksm=ea044b58dd73c24e803e210726f6804d5c57b869373033d49f38279b4a77aa218ac3728e3cb9&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("超大群怎么保证抢红包公平"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483840&idx=1&sn=aa631873ce3e010cddaad4ee2b97e6d2&chksm=ea044b5fdd73c249c68ab7c98d81f65e358cf3765b653ac1454834c7fba714d6ef55e66fac0b&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("别人读没读你的消息，你如何知道？"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483830&idx=1&sn=b049558916512f4e1d4f34c5489a1d46&chksm=ea044b29dd73c23fae4508d555446a57c517dcc0c0b1ad47ad0003bb8df44cf04b8d6f1be3ad&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("大规模群消息推送如何保证实时性？"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483812&idx=1&sn=26b455c51913af0012ccbe589b4aa355&chksm=ea044b3bdd73c22d8aa6d44fc2cf6d396bd125b92fe229b19dfd4ac456a9b3a5a3c9c00a6963&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("基于消息总线的高可扩展性IM系统后台架构设计"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483787&idx=1&sn=4547e00ad7f68d103284ff956fdff802&chksm=ea044b14dd73c202cfc948d54e5777d443288ef05d37f7b2fc70dcb4120ce607c90759a3e88e&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("HashMap加双向链表构建IM系统会话列表内存模型"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483782&idx=1&sn=ad5a72f8ec2a35766f30a43db57ee61b&chksm=ea044b19dd73c20fdfc69b694c77317394f47468c2960ba9cbae007f4d28e3a5af37cdcb7bf1&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("低成本确保消息时序的方法"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483725&idx=1&sn=3aec201e78b30c6cd7988dfbf4180126&chksm=ea044bd2dd73c2c450d6c4dec29a8e7fbfbc2e55f110955ae151516d845480b0be3146ad1c41&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("IM移动端怎么搜索本地聊天记录"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("strong",[e._v("存储")]),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483795&idx=1&sn=2c1800cda277e218297bb7415e501b3a&chksm=ea044b0cdd73c21a1dfc509210ea81d77bcb384807a528f90f3f09d3e95731a9f2709b80ac64&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("IM系统海量消息数据是怎么存储的？"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247484130&idx=1&sn=78cb3277b2cd5838e2c8ff13371a0b27&chksm=ea04487ddd73c16b08edf1734306a4525b2b3333e44484de77e7ed4426927027e949b490daf4&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("HBase存储IM消息，RowKey该怎么设计？"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("strong",[e._v("安全")]),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247484029&idx=1&sn=5d0d4c8f35b41bcbb24ff800ed07922f&chksm=ea0448e2dd73c1f4533d398f74bb7711c38297586ed0333d9d337ef83480f617efd6d0eaa232&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("JWT技术解决IM系统的认证痛点"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483791&idx=1&sn=4eb1477f4cd186f5fc6f5912d0746066&chksm=ea044b10dd73c206af3a44233f432474dc0ccd49917abe1a0816a2e99055dbb8930644e4b778&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("为什么相同的消息微信每次加密后发送的内容都不一样？"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483834&idx=1&sn=5f5079643d1df99e4b1194c75e69b72d&chksm=ea044b25dd73c23369048d9dd1abfd5d4ec0a7806450e24475e39eabefcd49d5013255ee9fb5&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("IM系统服务端消息加解密方案"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("strong",[e._v("应用")]),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483927&idx=1&sn=16ad6c91d56b195c6f8a219f854dc7f7&chksm=ea044888dd73c19e1f610133d2931b5b3cf6b7dddcf67f1b46782035092ff1733864990b42cd&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("瓜子智能在线客服整体架构"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("strong",[e._v("用到的一些算法")]),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247484058&idx=1&sn=5b8b8dac57de9cd4377c88d574613d38&chksm=ea044805dd73c113e249314a224d017e2ed863be923e13232aba2629ee54d9fa74dca5030e91&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("ID生成策略——SnowFlake"),t("OutboundLink")],1),t("br"),e._v(" "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247484066&idx=1&sn=aa259955f5726c2c6d23d91f55a05144&chksm=ea04483ddd73c12b02c3c60f1e04ba138864e0bee50283745f290f79827180234523ff9f0644&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("10分钟弄懂Raft算法"),t("OutboundLink")],1)])])}),[],!1,null,null,null);r.default=a.exports}}]);